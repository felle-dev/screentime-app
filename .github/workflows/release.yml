name: Release CI

on:
  push:
    branches: [ "kt-rewrite" ]
  pull_request:
    branches: [ "kt-rewrite" ]
  workflow_dispatch:


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Set up JDK 17
        uses: actions/setup-java@v4.2.1
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Install Android Build Tools
        run: sdkmanager "build-tools;29.0.3"

      - name: Give permission to executable
        run: chmod +x gradlew

      - name: Clear build cache
        uses: gradle/gradle-build-action@v3.1.0
        with:
          gradle-version: wrapper # Use nightly via gradlew if configured in wrapper
          arguments: clean

      - name: Build Lite Release APK
        run: ./gradlew assembleLiteRelease

      - name: Sign Lite Variant APKs
        uses: r0adkll/sign-android-release@v1
        id: sign_app_lite
        with:
          releaseDirectory: app/build/outputs/apk/lite/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      - name: Get APK Info
        id: apk_info
        run: |
          APK_PATH=${{ steps.sign_app_lite.outputs.signedReleaseFile }}
          APK_NAME=$(basename "$APK_PATH")
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT

      - name: Send Signed APK to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_BETA_WEBHOOK }}
        run: |
          APK_PATH=${{ steps.apk_info.outputs.apk_path }}
          APK_NAME=${{ steps.apk_info.outputs.apk_name }}
          APK_SIZE=${{ steps.apk_info.outputs.apk_size }}
          COMMIT_MESSAGE=$(git log -1 --pretty=format:%s)
          COMMIT_AUTHOR=$(git log -1 --pretty=format:%an)
          AUTHOR_URL="https://github.com/${{ github.actor }}"
          COMMIT_SHA=${{ github.sha }}
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/$COMMIT_SHA"
          
          # Format Discord message as JSON
          MESSAGE=$(cat <<EOF
          {
            "embeds": [{
              "title": "New Beta Release",
              "description": "A new signed beta APK has been built and is ready for testing!",
              "color": 5814783,
              "fields": [
                {"name": "Size", "value": "$APK_SIZE", "inline": true},
                {"name": "Commit", "value": "[#$COMMIT_SHA]($COMMIT_URL)", "inline": false},
                {"name": "Message", "value": "$COMMIT_MESSAGE", "inline": false},
                {"name": "Author", "value": "[$COMMIT_AUTHOR]($AUTHOR_URL)", "inline": false}
              ],
              "footer": {"text": "Built with Github Actions"},
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            }],
            "attachments": []
          }
          EOF
          )
          
          # Upload APK and send message
          curl -X POST \
            -H "Content-Type: multipart/form-data" \
            -F "payload_json=$MESSAGE" \
            -F "file=@$APK_PATH" \
            "$DISCORD_WEBHOOK"



      - name: Send Signed APK to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          APK_PATH=${{ steps.apk_info.outputs.apk_path }}
          APK_NAME=${{ steps.apk_info.outputs.apk_name }}
          APK_SIZE=${{ steps.apk_info.outputs.apk_size }}
          COMMIT_SHA=${{ github.sha }}
          COMMIT_MESSAGE="${{ steps.apk_info.outputs.commit_message }}"
          COMMIT_AUTHOR="${{ steps.apk_info.outputs.commit_author }}"
          AUTHOR_URL="https://github.com/${{ github.actor }}"
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/$COMMIT_SHA"
          
          # Format Telegram message (Markdown)
          MESSAGE="**New Beta Release** \n" # %0A = newline
          
          MESSAGE+="A new signed beta APK is ready! \n\n"
          
          
          MESSAGE+="*Commit:* [$COMMIT_SHA]($COMMIT_URL) \n"
          
          MESSAGE+="*Message:* $COMMIT_MESSAGE \n\n"
          
          
          MESSAGE+="*Author:* [$COMMIT_AUTHOR]($AUTHOR_URL) \n"
          MESSAGE+="Built with Github Actions on $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          # Send message with file
          curl -X POST \
            -F chat_id="-1002199979475" \
            -F message_thread_id="437" \
            -F document=@"$APK_PATH" \
            -F "caption=$MESSAGE" \
            -F "parse_mode=Markdown" \
            "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument"

      - name: Upload Signed Lite Release APK
        uses: actions/upload-artifact@v4
        with:
          name: lite-release-apk
          path: ${{ steps.sign_app_lite.outputs.signedReleaseFile }}